google_api_key="AIzaSyAweIMkemCM-v-dojTn7swvPf-9KwtLot0";mapIcons=null;function loadGoogleMapsApi(b){var a=document.createElement("script");a.type="text/javascript";a.src="http://maps.googleapis.com/maps/api/js?key="+google_api_key+"&sensor=false&callback="+b;document.body.appendChild(a)}function onGoogleMapsApiLoaded(){iconSize=google.maps.Size(22,26);mapIcons={};mapIcons.blue={url:"/static/img/site/common/standard/icon_destination-check_s22_blue.png",size:iconSize};mapIcons.red={url:"/static/img/site/common/standard/icon_destination-add_s22_red.png",size:iconSize};mapIcons.green={url:"/static/img/site/common/standard/icon_destination_s22_green.png",size:iconSize};mapIcons.shadow=new google.maps.MarkerImage("/static/img/site/common/standard/icon_destination-shadow_s22.png",new google.maps.Size(31,16),new google.maps.Point(0,0),new google.maps.Point(5,14));$(".map").each(function(){initializeMap(this)})}function initializeMap(c){center=$(c).find(".center")[0];latitude=center.attributes.latitude.value;longitude=center.attributes.longitude.value;mapCanvasNode=$(c).find(".canvas")[0];var a={center:new google.maps.LatLng(latitude,longitude),zoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP};var b=new google.maps.Map(mapCanvasNode,a);$(c).find(".trip .stop").each(function(){latitude=this.attributes.latitude.value;longitude=this.attributes.longitude.value;marker=new google.maps.Marker({position:new google.maps.LatLng(latitude,longitude),icon:mapIcons.blue,shadow:mapIcons.shadow,map:b})});$(c).find(".place").each(function(){latitude=this.attributes.latitude.value;longitude=this.attributes.longitude.value;marker=new google.maps.Marker({position:new google.maps.LatLng(latitude,longitude),icon:mapIcons.red,shadow:mapIcons.shadow,map:b})})}$(function(){loadGoogleMapsApi("onGoogleMapsApiLoaded")});var fillZeroes="00000000000000000000";function pad_zeros(c,b){var a=c+"";return(fillZeroes.slice(0,b-a.length)+a)}log=function(a){};if(DEBUG){log=function(a){d=new Date();date_str=pad_zeros(d.getHours(),2)+":"+pad_zeros(d.getMinutes(),2)+":"+pad_zeros(d.getSeconds(),2)+":"+pad_zeros(d.getMilliseconds(),3);console.log(date_str+" "+a)}}function wrap(f,c,a,b){var e=f[c];f[c]=function(){if(a){a.apply(this,arguments)}var g=e.apply(this,arguments);if(b){g=b.call(this,g)}return g}}$.on_dom_insert=function on_dom_insert(a,b){if(!$.watchers){$.watchers=[]}$.watchers.push({fn:b,selector:a});$(a,document).each(b)};$.on_change=function on_change(a,b){$.on_dom_insert(a,function(){$(this).change(b)})};wrap($.prototype,"html",null,function(a){$.watchers.forEach(function(b){try{$(b.selector,a).each(b.fn)}catch(c){console.error("Uncaught "+c.name+": "+c.message)}});return a});wrap($,"parseHTML",null,function(a){$.watchers.forEach(function(b){try{$(a).filter(b.selector).each(b.fn);$(b.selector,a).each(b.fn)}catch(c){console.error("Uncaught "+c.name+": "+c.message)}});return a});function refreshSelectEmptyClass(a){if($(a).children(":selected").val()==""){$(a).addClass("empty")}else{$(a).removeClass("empty")}}$("select").each(function(){refreshSelectEmptyClass(this)}).on("change",function(a){refreshSelectEmptyClass(this)});var waitForFinalEvent=(function(){var a={};return function(e,b,c){if(!c){c="Don't call this twice without a uniqueId"}if(a[c]){clearTimeout(a[c])}a[c]=setTimeout(e,b)}})();function isTouchDevice(){return !!("ontouchstart" in window)||!!("onmsgesturechange" in window)}$(function(){history.replaceState("foo","");window.onpopstate=function(e){if(e.state){document.location.reload()}};function c(){var i=$("#whenstart")[0];var f=$("#whenend")[0];if(!i||!f){return}var e=new Date();var g=new Date(e);g.setUTCMonth(e.getUTCMonth()+6);i.setAttribute("min",b(e));f.setAttribute("max",b(g));if(i.attributes.value){e=a(i.attributes.value.value)}else{i.attributes.value=b(e)}if(f.attributes.value){g=a(f.attributes.value.value)}else{f.attributes.value=b(g)}var h=new Date(e);h.setUTCDate(h.getUTCDate()+1);f.setAttribute("min",b(h));h=new Date(g);h.setUTCDate(h.getUTCDate()-1);i.setAttribute("max",b(h))}function b(g){var f=g.getUTCMonth()+1;if(f<10){f="0"+f}var e=g.getUTCDate();if(e<10){e="0"+e}return g.getUTCFullYear()+"-"+f+"-"+e}function a(e){e=e.substring(0,e.indexOf(" "));parts=e.split("-");date=new Date(parts[0],parts[1]-1,parts[2]);return date}c();$.on_change("#whenstart",c);$.on_change("#whenend",c);$.on_change("input.autosubmit",function(){$(this.form).submit()});$(document).on("touchstart click","a.formsubmit",function(){$(this).parents("form").submit();return false});$(document).on("click",".toggle_next",function(){$(this).next().toggle();return false})});$(function(){function a(h,c,e,i,b,g){var f=(h-c)/(e-c);return parseInt(f*(b-i)/g)*g+i}$.on_dom_insert(".slider",function(){var h=this;var q=$(".nub",h);var m=false;if(q.length==0){q=$('<span class="nub"></span>');q.appendTo(h)}else{console.log("hmm, this slider is getting set up twice.  will try the best i can.",h);m=true}h.getIntAttribute=function(r,s){return parseInt(h.getAttribute(r))||s};var f=h.getIntAttribute("min",1);var o=h.getIntAttribute("max",100);var g=h.getIntAttribute("step",1);var e=h.getIntAttribute("value",a(50,1,100,f,o,g));var b=h.getAttribute("name")||"";var l=h.getAttribute("type")||"hidden";var p=h.getAttribute("inputpos")=="before";var k=2;var i=$(h).width()-q.width()-2;function c(r){h.value=r;q[0].style.left=a(r,f,o,k,i,1)+"px"}c(e);function j(r){var r=$.Event(r);r.type="change";r.target=h;$(h).trigger(r)}var n;if(m){if(p){n=$(h).prev("input")}else{n=$(h).next("input")}}else{n=$('<input size="'+Math.max((o+"").length-1,1)+'" type="'+l+'" name="'+b+'" value="'+e+'" />');if(p){n.insertBefore($(h))}else{n.insertAfter($(h))}}n.change(function(r){if(n[0].value>o){n[0].value=o}else{if(n[0].value<f){n[0].value=f}}c(n[0].value);j(r)});q.bind("mousedown touchstart",function(v){var t=n[0].value;var u=q.position().left;var s=v.originalEvent.pageX;var r=s;q.addClass("active");$(document).bind("touchend mouseup",function(w){q.removeClass("active");$(document).unbind("touchmove mousemove");$(document).unbind("touchend mouseup");if(n[0].value!=t){j(w)}});$(document).bind("touchmove mousemove",function(x){r=x.originalEvent.pageX;var w=u+r-s;if(w<k){w=k}else{if(w>i){w=i}}var y=a(w,k,i,f,o,g);c(y);n[0].value=y});return false})})});$(function(){$.on_dom_insert(".accordian",function(){var a=this;$(".title",a).click(function(){$(a).toggleClass("collapsed");return false})})});function add_cities(g,c,h,j,a,l,b){for(var f=0;f<h.length;f++){var e=h[f];var k=new L.marker([e.lat,e.lon],{icon:j});(function(m,i){$("#city_tile"+m.id).on("mouseover",function(){i.setIcon(a)});$("#city_tile"+m.id).on("mouseout",function(){i.setIcon(j)})}(e,k));k.city=e;k.on("mouseover",function(i){$("#city_tile"+this.city.id).addClass("selected");$("#key").html(this.city.name).css({left:i.originalEvent.layerX-35,top:i.originalEvent.layerY-35}).show()}).on("mouseout",function(i){$("#city_tile"+this.city.id).removeClass("selected");$("#key").hide()}).on("click",function(i){show_dialog_by_url(i,false,"/trips/"+c.external_id+"/stop-details?geonameid="+this.city.id)});k.addTo(g);if(l){b.extend([e.lat,e.lon])}}}var map,pathLayer,cityLayer;function setup_map(a){if(!$("#map").length){return}if(typeof(L)=="undefined"){return}var h=new L.LatLngBounds();if(!map){map=L.map("map",{attributionControl:false,scrollWheelZoom:false});(new L.TileLayer("http://{s}.tiles.mapbox.com/v3/ari.map-4xhqijbx/{z}/{x}/{y}.png",{subdomains:["a","b","c","d"],maxZoom:14})).addTo(map);pathLayer=L.layerGroup().addTo(map);cityLayer=L.layerGroup().addTo(map);var f=$('<div id="key"></div>');f.appendTo($("#map"))}else{pathLayer.clearLayers();cityLayer.clearLayers()}checkIcon=L.icon({iconUrl:"/static/ext/glyphicons/glyphicons_193_circle_ok_green.png",});checkIconSelected=L.icon({iconUrl:"/static/ext/glyphicons/glyphicons_193_circle_ok_green_2.png",});plusIcon=L.icon({iconUrl:"/static/ext/glyphicons/glyphicons_190_circle_plus_blue.png",});plusIconSelected=L.icon({iconUrl:"/static/ext/glyphicons/glyphicons_190_circle_plus_blue_2.png",});add_cities(cityLayer,a.trip,[a.start],checkIcon,checkIconSelected,false,h);add_cities(cityLayer,a.trip,a.included,checkIcon,checkIconSelected,false,h);add_cities(cityLayer,a.trip,a.suggestions,plusIcon,plusIconSelected,true,h);var c=L.geoJson(null,{style:function(i){switch(i.properties.verb){case"fly":return{color:"#0000ff"};default:return{color:"#ff0000"}}},onEachFeature:function(j,i){i.on("mouseover",function(l){$("#key").html(j.properties.description).css({left:l.originalEvent.layerX-35,top:l.originalEvent.layerY-50}).show()});i.on("mouseout",function(l){$("#key").hide()})}}).addTo(pathLayer);var k=null;if(a.path){for(var e=0;e<a.path.length;e++){var g=a.path[e];if(k&&(k.name!=g.cities[0].name)){c.addData(geoJsonLine(k,g.cities[0],{verb:"drive-to-airport",description:k.name+" -> "+g.cities[0].name},false))}k=g.cities[g.cities.length-1];if(g.cities.length>1){for(var b=1;b<g.cities.length;b++){c.addData(geoJsonLine(g.cities[b-1],g.cities[b],{verb:g.verb,description:g.cities[b-1].name+" -> "+g.cities[b].name},g.verb=="fly"))}}}}mapEventsOff(map);map.fitBounds(h);mapEventsOn(map)}function mapEventsOff(a){a.off("movend",onMapViewChanged);a.off("dragend",onMapViewChanged);a.off("zoomend",onMapViewChanged)}function mapEventsOn(a){a.on("movend",onMapViewChanged);a.on("dragend",onMapViewChanged);a.on("zoomend",onMapViewChanged)}function onMapViewChanged(a){$("#swlat").val(map.getBounds().getSouthWest().lat);$("#swlng").val(map.getBounds().getSouthWest().lng);$("#nelat").val(map.getBounds().getNorthEast().lat);$("#nelng").val(map.getBounds().getNorthEast().lng);$("#searchByMapView").submit()}function geoJsonLine(e,a,c,b){if(b){e=new arc.Coord(e.longitude,e.latitude);a=new arc.Coord(a.longitude,a.latitude);line=new arc.GreatCircle(e,a,c).Arc(30);return line.json()}else{return{type:"Feature",properties:c,geometry:{type:"LineString",coordinates:[[e.longitude,e.latitude],[a.longitude,a.latitude]]}}}}function hide_dialog(){var a=$("#dialog");a.hide();document.body.style.overflow=""}function show_dialog_with_content(f,c,a){if(a.innerHTML){$("#form_contents").html(a.innerHTML)}else{$("#form_contents").html(a)}var b=$("#dialog");if(c){b[0].style.left=(Math.max(5,f.currentTarget.offsetLeft-80))+"px";b[0].style.top=(f.currentTarget.offsetTop+25)+"px"}else{document.body.style.overflow="hidden"}b.show();return false}function show_dialog_by_url(c,b,a){jQuery.ajax(a,{success:function(e){show_dialog_with_content(c,b,e)}})}function show_dialog(f,c){var b=f.currentTarget.getAttribute("formurl");if(b){show_dialog_by_url(f,c,b)}else{var a=$("#"+f.currentTarget.getAttribute("formid"))[0];show_dialog_with_content(f,c,a)}return false}$(function(){$(document).keydown(function(b){if(b.which==27){hide_dialog()}});$(document).on("click","a.show_form",show_dialog);$(document).on("click","#dialog .controls :input",hide_dialog);var a=false;$(document).on("click","#dialog",function(){if(!a){hide_dialog()}a=false});$(document).on("click","#dialog #form_contents",function(){a=true})});$(function(){function disableForm(form){$(form).find(".error_message").html("");$(form).find("button[type=submit]").attr("disabled","disabled");$(form).find("input, textarea, select, button").addClass("disabled")}function enableForm(form){$(form).find("button[type=submit]").removeAttr("disabled");$(form).find("input, textarea, select, button").removeClass("disabled")}function ajax_form(success_fn,blockInteraction){return function(e){log("ajax_form starting");var form=e.currentTarget;if(blockInteraction){form.target="fake_ajax";document.body.style.overflow="hidden";disableForm(form);$("#fake_ajax").unbind("load");log("ajax_form loading");$("#fake_ajax").load(function(){ga("send","event","ajax",form.action);log("ajax_form loading done, now to eval result");document.body.style.overflow="";var r;try{eval("r = "+$("#fake_ajax")[0].contentDocument.body.textContent+";")}catch(ex){$("#fake_ajax").show();return}enableForm(form);log("ajax_form done eval, now processing response");success_fn(r)});$("#fake_ajax").error(function(){alert("error!")})}else{disableForm(form);$.ajax({async:true,type:form.method,url:form.action,data:$(form).serialize(),success:function(r){try{enableForm(form);res=eval("("+r+")");success_fn(res)}catch(ex){alert("Error interpreting AJAX results as JSON");return}},error:function(e){enableForm(form);alert("error loading ajax endpoint (see console)")}});return false}hide_dialog()}}$.on_dom_insert(".ajaxify",function(){ajaxify_form(this,true)});$.on_dom_insert(".autosubmit-using-ajaxify",function(){ajaxify_form(this,false);var result=$(this).submit()});function ajaxify_form(form,blockInteraction){$(form).submit(ajax_form(function(res){if(res.redirect_url){window.location=res.redirect_url;return}for(var i=0;i<res.node_updates.length;i++){var update=res.node_updates[i];var node=$("#"+update.dom_id);if(update.mode=="append"){node.html(node.html()+update.html)}else{node.html(update.html)}}log("ajax_form done processing response, now the map");if(res.map){setup_map(res.map)}log("ajax_form done!")},blockInteraction))}});$(function(){$.on_dom_insert(".autocomplete",function(){if(!$(this).parents("form").length){return}$(this).autocomplete({autoFocus:true,minLength:3,source:this.getAttribute("datasrc"),select:function(event,ui){this.form[this.name.substr(0,this.name.length-"str".length)+"id"].value=ui.item.id;this.form[this.name].value=ui.item.label;if(this.getAttribute("autosubmit")=="true"){$(this.form).submit()}return true}});$(this).focus(function(){this.select();var me=$(this);me.mouseup(false);setTimeout(function(){me.unbind("mouseup",false)},500)})});$.on_dom_insert(".tokenizer",function(){if(!$(this).parents("form").length){return}$(this).tokenInput(this.getAttribute("datasrc"),{queryParam:"term",searchDelay:200,minChars:3,propertyToSearch:"label",animateDropdown:false,preventDuplicates:true,prePopulate:eval(this.value)})})});$(function(){$.on_dom_insert(".panoramio_widget",function(){if(typeof(panoramio)=="undefined"){return}var a={width:592,height:350,croppedPhotos:false};var e=Number(this.getAttribute("latitude"));var c=Number(this.getAttribute("longitude"));var b={rect:{sw:{lat:e-0.25,lng:c-0.25},ne:{lat:e+0.25,lng:c+0.25}}};widget=new panoramio.PhotoWidget(this,b,a);widget.setPosition(0)})});if(typeof(google)!="undefined"){google.load("visualization","1.0",{packages:["corechart"]})}$(function(){$.on_dom_insert(".chart",function(){if(typeof(google)=="undefined"){return}var a={title:this.getAttribute("charttitle"),width:592,height:200,};if($(".column",this).length==0){return}var c=new google.visualization.DataTable();$(".column",this).each(function(){c.addColumn(this.getAttribute("type"),this.getAttribute("label"))});$(".row",this).each(function(){var e=[];$(".data",this).each(function(){var g=this.getAttribute("value");if(this.getAttribute("type")=="number"){g=Number(g)}else{if(this.getAttribute("type")=="month"){var f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"];g=f[parseInt(g)-1]}}e.push(g)});c.addRow(e)});var b=new google.visualization.ColumnChart(this);b.draw(c,a)})});$.fn.capScrolling=function(e){var c=this;var a=c.offset().top;var b=e-a;$(window).scroll(function(f){if($(window).scrollTop()>b){c.css({position:"absolute",top:e})}else{c.css({position:"fixed",top:a})}})};$(function(){var a=$(".page_menu");if(a.length!=1){return}pageMenu=a[0];menuItems="";$targets=$(".page_menu_target");$targets.each(function(){id=this.id;name=id.replace(/_/g," ");menuItem='<li id="'+id+'_item"><a href="#'+id+'">'+name+"</a></li>";menuItems+=menuItem});pageMenu.innerHTML=menuItems;var b=$(pageMenu).offset().top;$(window).scroll(function(c){if($(window).scrollTop()<b){$(pageMenu).css({position:"static",top:""})}else{$(pageMenu).css({position:"fixed",top:0})}});$(".page_menu a").click(function(){href=$(this).attr("href");aTag=$(href);$("html,body").animate({scrollTop:aTag.offset().top-50},500);return false});$(window).scroll(function(c){waitForFinalEvent(function(){chosen=null;chosenDistanceFromTop=null;windowPos=$(window).scrollTop();$targets.each(function(){distanceFromTop=Math.abs($(this).offset().top-windowPos);if(chosen==null||distanceFromTop<chosenDistanceFromTop){chosen=this;chosenDistanceFromTop=distanceFromTop}});$(".page_menu li").removeClass("selected");$("#"+chosen.id+"_item").addClass("selected")},20,"position overlay")})});$(function(){var c=500;function f(){$.getJSON("/dana/get-route",{},b)}function b(g){if(g.route_summary){$(".trip_box .estimated_price").html(g.estimated_price);$(".trip_box .route_summary").html(g.route_summary);a()}else{$(".trip_box .estimated_price").html("-");$(".trip_box .verified_price").html("-")}}function a(){routeSummary=$(".trip_box .route_summary")[0].innerHTML;if(routeSummary){$.getJSON("/dana/get-verified-price",{routeSummary:routeSummary},e)}}function e(g){if(g.status=="no available seats"){$(".trip_box .verified_price").html("No available seats");return}if(g.status=="OK"){$(".trip_box .verified_price").html(g.verified_price);return}setTimeout(a,c)}tripBoxen=$(".trip_box");if(tripBoxen.length){f()}});$(function(){function a(){geonameid=$(".add_destination_box .geonameid")[0].innerHTML;$.getJSON("/dana/estimate-extra-cost",{geonameid:geonameid},b)}function b(c){$(".add_destination_box .flight.price").html(c.estimate)}boxes=$(".add_destination_box");if(boxes.length){a()}});